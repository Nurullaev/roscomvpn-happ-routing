name: Update Routing Configs

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
      - ".gitignore"
      - "LICENSE"
  repository_dispatch:
    types: [update-routing-configs]

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Update HAPP configs
        shell: bash
        run: |
          set -euo pipefail
          export TZ=UTC

          GEOIP_REPO="hydraponique/roscomvpn-geoip"
          GEOSITE_REPO="hydraponique/roscomvpn-geosite"

          latest_tag() {
            git ls-remote --tags "https://github.com/${1}.git" \
              | awk '{print $2}' \
              | sed -E 's@refs/tags/@@; s@\^\{\}@@' \
              | grep -E '^[0-9]{12}$' \
              | sort -r \
              | head -n 1
          }

          epoch_to_tag_utc() {
            local e="${1:-0}"
            if [[ "$e" =~ ^[0-9]+$ ]] && (( e > 0 )); then
              date -u -d "@$e" +%Y%m%d%H%M
            else
              printf '000000000000'
            fi
          }

          current_epoch="$(jq -r '.LastUpdated // empty' HAPP/DEFAULT.JSON 2>/dev/null || true)"
          [[ "$current_epoch" =~ ^[0-9]+$ ]] || current_epoch="0"
          current_tag="$(epoch_to_tag_utc "$current_epoch")"

          geoip_tag="$(latest_tag "$GEOIP_REPO")"
          geosite_tag="$(latest_tag "$GEOSITE_REPO")"
          [[ -n "$geoip_tag" && -n "$geosite_tag" ]]

          max_tag="$(printf "%s\n%s\n" "$geoip_tag" "$geosite_tag" | sort -r | head -n 1)"

          if [[ "$current_tag" < "$max_tag" ]]; then
            now_epoch="$(date -u +%s)"
            geoip_url="https://cdn.jsdelivr.net/gh/${GEOIP_REPO}@${geoip_tag}/release/geoip.dat"
            geosite_url="https://cdn.jsdelivr.net/gh/${GEOSITE_REPO}@${geosite_tag}/release/geosite.dat"

            curl -fsSLI "$geoip_url" >/dev/null
            curl -fsSLI "$geosite_url" >/dev/null

            tmp="$(mktemp)"
            jq \
              --arg ts "$now_epoch" \
              --arg geoip "$geoip_url" \
              --arg geosite "$geosite_url" \
              '.LastUpdated = $ts | .Geoipurl = $geoip | .Geositeurl = $geosite' \
              HAPP/DEFAULT.JSON > "$tmp"
            mv "$tmp" HAPP/DEFAULT.JSON
          fi

          tmp="$(mktemp)"
          jq \
            '.UseChunkFiles = "false"
             | .DirectSites = []
             | .DirectIp = []
             | .ProxySites = []
             | .ProxyIp = []
             | .BlockSites = []
             | .BlockIp = []' \
            HAPP/DEFAULT.JSON > "$tmp"
          mv "$tmp" HAPP/JSONSUB.JSON

          default_b64="$(jq -c . HAPP/DEFAULT.JSON | base64 -w 0)"
          jsonsub_b64="$(jq -c . HAPP/JSONSUB.JSON | base64 -w 0)"

          printf 'happ://routing/onadd/%s\n' "$default_b64" > HAPP/DEFAULT.DEEPLINK
          printf 'happ://routing/onadd/%s\n' "$jsonsub_b64" > HAPP/JSONSUB.DEEPLINK
          
      - name: Update INCY configs
        shell: bash
        run: |
          set -euo pipefail
          export TZ=UTC

          GEOIP_REPO="hydraponique/roscomvpn-geoip"
          GEOSITE_REPO="hydraponique/roscomvpn-geosite"

          latest_tag() {
            git ls-remote --tags "https://github.com/${1}.git" \
              | awk '{print $2}' \
              | sed -E 's@refs/tags/@@; s@\^\{\}@@' \
              | grep -E '^[0-9]{12}$' \
              | sort -r \
              | head -n 1
          }

          epoch_to_tag_utc() {
            local e="${1:-0}"
            if [[ "$e" =~ ^[0-9]+$ ]] && (( e > 0 )); then
              date -u -d "@$e" +%Y%m%d%H%M
            else
              printf '000000000000'
            fi
          }

          current_epoch="$(jq -r '.LastUpdated // empty' INCY/DEFAULT.JSON 2>/dev/null || true)"
          [[ "$current_epoch" =~ ^[0-9]+$ ]] || current_epoch="0"
          current_tag="$(epoch_to_tag_utc "$current_epoch")"

          geoip_tag="$(latest_tag "$GEOIP_REPO")"
          geosite_tag="$(latest_tag "$GEOSITE_REPO")"
          [[ -n "$geoip_tag" && -n "$geosite_tag" ]]

          max_tag="$(printf "%s\n%s\n" "$geoip_tag" "$geosite_tag" | sort -r | head -n 1)"

          if [[ "$current_tag" < "$max_tag" ]]; then
            now_epoch="$(date -u +%s)"
            geoip_url="https://cdn.jsdelivr.net/gh/${GEOIP_REPO}@${geoip_tag}/release/geoip.dat"
            geosite_url="https://cdn.jsdelivr.net/gh/${GEOSITE_REPO}@${geosite_tag}/release/geosite.dat"

            curl -fsSLI "$geoip_url" >/dev/null
            curl -fsSLI "$geosite_url" >/dev/null

            tmp="$(mktemp)"
            jq \
              --arg ts "$now_epoch" \
              --arg geoip "$geoip_url" \
              --arg geosite "$geosite_url" \
              '.LastUpdated = $ts | .Geoipurl = $geoip | .Geositeurl = $geosite' \
              INCY/DEFAULT.JSON > "$tmp"
            mv "$tmp" INCY/DEFAULT.JSON
          fi

          tmp="$(mktemp)"
          jq \
            '.UseChunkFiles = "false"
             | .DirectSites = []
             | .DirectIp = []
             | .ProxySites = []
             | .ProxyIp = []
             | .BlockSites = []
             | .BlockIp = []' \
            INCY/DEFAULT.JSON > "$tmp"
          mv "$tmp" INCY/JSONSUB.JSON

          default_b64="$(jq -c . INCY/DEFAULT.JSON | base64 -w 0)"
          jsonsub_b64="$(jq -c . INCY/JSONSUB.JSON | base64 -w 0)"

          printf 'incy://routing/onadd/%s\n' "$default_b64" > INCY/DEFAULT.DEEPLINK
          printf 'incy://routing/onadd/%s\n' "$jsonsub_b64" > INCY/JSONSUB.DEEPLINK

      - name: Commit and push changes
        shell: bash
        run: |
          set -euo pipefail
          export TZ=UTC

          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add HAPP/DEFAULT.JSON HAPP/JSONSUB.JSON HAPP/DEFAULT.DEEPLINK HAPP/JSONSUB.DEEPLINK INCY/DEFAULT.JSON INCY/JSONSUB.JSON INCY/DEFAULT.DEEPLINK INCY/JSONSUB.DEEPLINK

          if git diff --cached --quiet; then
            exit 0
          fi

          git commit -m "$(date -u +%Y%m%d%H%M)"
          git push
